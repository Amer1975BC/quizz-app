name: Quiz App Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: quiz
          POSTGRES_PASSWORD: quizpass_test
          POSTGRES_DB: quizdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Set up database
      env:
        DATABASE_URL: postgresql+psycopg2://quiz:quizpass_test@localhost:5432/quizdb
      run: |
        # Create tables and populate with test data
        python -c "from webapi import engine, Base; Base.metadata.create_all(bind=engine)"
        
        # Add some test questions if needed
        python -c "
        from webapi import SessionLocal, Question, Choice
        db = SessionLocal()
        if db.query(Question).count() == 0:
            # Add minimal test questions
            q1 = Question(text='Test question 1?', explanation=None)
            db.add(q1)
            db.flush()
            db.add(Choice(question_id=q1.id, text='Option A', is_correct=True))
            db.add(Choice(question_id=q1.id, text='Option B', is_correct=False))
            
            q2 = Question(text='PSPO1 test question?', explanation='PSPO1')
            db.add(q2)  
            db.flush()
            db.add(Choice(question_id=q2.id, text='Option A', is_correct=True))
            db.add(Choice(question_id=q2.id, text='Option B', is_correct=False))
            
            db.commit()
        db.close()
        "

    - name: Run Python tests
      env:
        DATABASE_URL: postgresql+psycopg2://quiz:quizpass_test@localhost:5432/quizdb
      run: |
        pytest test_api.py -v

    - name: Set up Node.js for frontend tests
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Run frontend tests
      run: |
        node test_frontend.js

    - name: Start application for integration tests
      env:
        DATABASE_URL: postgresql+psycopg2://quiz:quizpass_test@localhost:5432/quizdb
      run: |
        python webapi.py &
        sleep 5
        
        # Test basic endpoints
        curl -f http://localhost:8000/ || exit 1
        curl -f http://localhost:8000/static/app.js || exit 1
        
        # Test API
        SESSION_ID=$(curl -s -X POST "http://localhost:8000/api/start?category=general" | python -c "import sys, json; print(json.load(sys.stdin)['session_id'])")
        curl -f "http://localhost:8000/api/question?sid=$SESSION_ID" || exit 1

  build-docker:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -t quiz-app .

    - name: Test Docker compose
      run: |
        docker-compose up -d
        sleep 30
        
        # Test application is running
        curl -f http://localhost:9080/ || exit 1
        
        docker-compose down

    - name: Run full integration tests
      run: |
        docker-compose up -d
        sleep 30
        ./run_tests.sh
        docker-compose down